---
import MainLayout from '@layouts/MainLayout.astro';
import { getCollection } from 'astro:content';

const title = '搜索 | 个人技术博客-bigroc';
const description = '搜索博客文章';

// 获取所有文章数据用于搜索
const allPosts = (await getCollection('posts'))
  .filter(post => !post.data.draft)
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime())
  .map(post => ({
    id: post.id.replace('.md', ''),
    title: post.data.title,
    date: post.data.date.toISOString(),
    dateFormatted: post.data.date.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' }),
    tags: post.data.tags,
    categories: post.data.categories,
    summary: post.data.summary,
  }));
---

<MainLayout title={title} description={description}>
  <div class="mb-8">
    <h1 class="text-4xl font-bold mb-6">搜索文章</h1>
    
    <!-- 搜索框 -->
    <div class="relative">
      <input
        type="text"
        id="search-input"
        placeholder="输入关键词搜索文章标题、标签或摘要..."
        class="w-full px-4 py-3 pr-12 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100"
        autofocus
      />
      <svg class="absolute right-4 top-3.5 w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
      </svg>
    </div>

    <!-- 搜索统计 -->
    <div id="search-stats" class="mt-4 text-sm text-gray-600 dark:text-gray-400"></div>
  </div>

  <!-- 搜索结果 -->
  <div id="search-results" class="space-y-8"></div>

  <!-- 无结果提示 -->
  <div id="no-results" class="hidden text-center py-12">
    <svg class="mx-auto w-16 h-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
    </svg>
    <p class="text-gray-600 dark:text-gray-400 text-lg">没有找到相关文章</p>
    <p class="text-gray-500 dark:text-gray-500 text-sm mt-2">试试其他关键词吧</p>
  </div>

  <!-- 初始提示 -->
  <div id="search-prompt" class="text-center py-12">
    <svg class="mx-auto w-16 h-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
    </svg>
    <p class="text-gray-600 dark:text-gray-400 text-lg">输入关键词开始搜索</p>
    <p class="text-gray-500 dark:text-gray-500 text-sm mt-2">共 {allPosts.length} 篇文章可供搜索</p>
  </div>
</MainLayout>

<script define:vars={{ allPosts }}>
  const searchInput = document.getElementById('search-input');
  const searchResults = document.getElementById('search-results');
  const searchStats = document.getElementById('search-stats');
  const noResults = document.getElementById('no-results');
  const searchPrompt = document.getElementById('search-prompt');

  // 搜索函数
  function searchPosts(query) {
    if (!query.trim()) {
      searchResults.innerHTML = '';
      searchStats.textContent = '';
      noResults.classList.add('hidden');
      searchPrompt.classList.remove('hidden');
      return;
    }

    searchPrompt.classList.add('hidden');
    const keywords = query.toLowerCase().split(/\s+/).filter(k => k.length > 0);
    
    // 搜索匹配
    const results = allPosts.filter(post => {
      const searchText = [
        post.title,
        post.summary,
        ...post.tags,
        ...post.categories
      ].join(' ').toLowerCase();

      return keywords.some(keyword => searchText.includes(keyword));
    });

    // 计算相关度评分
    const scoredResults = results.map(post => {
      let score = 0;
      const titleLower = post.title.toLowerCase();
      const summaryLower = post.summary.toLowerCase();
      const tagsLower = post.tags.map(t => t.toLowerCase()).join(' ');

      keywords.forEach(keyword => {
        // 标题完全匹配：10分
        if (titleLower === keyword) score += 10;
        // 标题包含：5分
        else if (titleLower.includes(keyword)) score += 5;
        // 标签匹配：3分
        if (tagsLower.includes(keyword)) score += 3;
        // 摘要匹配：1分
        if (summaryLower.includes(keyword)) score += 1;
      });

      return { ...post, score };
    });

    // 按相关度排序
    scoredResults.sort((a, b) => b.score - a.score);

    // 显示结果
    if (scoredResults.length === 0) {
      searchResults.innerHTML = '';
      searchStats.textContent = '';
      noResults.classList.remove('hidden');
    } else {
      noResults.classList.add('hidden');
      searchStats.textContent = `找到 ${scoredResults.length} 篇相关文章`;
      
      searchResults.innerHTML = scoredResults.map(post => `
        <article class="border-b border-gray-200 dark:border-gray-800 pb-8 last:border-0">
          <h2 class="text-2xl font-bold mb-2">
            <a href="/posts/${post.id}" class="text-primary-600 dark:text-primary-400 hover:underline">
              ${highlightKeywords(post.title, keywords)}
            </a>
          </h2>
          <div class="flex flex-wrap gap-4 text-sm text-gray-600 dark:text-gray-400 mb-3">
            <time datetime="${post.date}">${post.dateFormatted}</time>
            ${post.tags.length > 0 ? `
              <div class="flex flex-wrap gap-2">
                ${post.tags.map(tag => `
                  <a href="/tags/${encodeURIComponent(tag)}" 
                     class="px-2 py-1 bg-primary-100 dark:bg-primary-900/30 text-primary-700 dark:text-primary-300 rounded text-xs hover:bg-primary-200 dark:hover:bg-primary-900/50 transition-colors">
                    ${tag}
                  </a>
                `).join('')}
              </div>
            ` : ''}
          </div>
          ${post.summary ? `
            <p class="text-gray-700 dark:text-gray-300 mb-3 line-clamp-2">
              ${highlightKeywords(post.summary, keywords)}
            </p>
          ` : ''}
          <a href="/posts/${post.id}" class="text-primary-600 dark:text-primary-400 hover:underline text-sm">
            阅读全文 →
          </a>
        </article>
      `).join('');
    }
  }

  // 高亮关键词
  function highlightKeywords(text, keywords) {
    let result = text;
    keywords.forEach(keyword => {
      const regex = new RegExp(`(${escapeRegex(keyword)})`, 'gi');
      result = result.replace(regex, '<mark class="bg-yellow-200 dark:bg-yellow-700 px-1 rounded">$1</mark>');
    });
    return result;
  }

  // 转义正则表达式特殊字符
  function escapeRegex(str) {
    return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  }

  // 防抖函数
  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  // 监听输入
  const debouncedSearch = debounce((e) => {
    searchPosts(e.target.value);
  }, 300);

  searchInput.addEventListener('input', debouncedSearch);

  // 从 URL 参数获取搜索关键词
  const urlParams = new URLSearchParams(window.location.search);
  const queryParam = urlParams.get('q');
  if (queryParam) {
    searchInput.value = queryParam;
    searchPosts(queryParam);
  }
</script>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
